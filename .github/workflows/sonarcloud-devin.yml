name: CI

on:
  # Manual trigger for demo - avoids conflict with other PR workflows
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to scan (leave empty for current branch)'
        required: false
        type: string
  # Also runs on PRs to specific branches for the demo flow
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

env:
  SONAR_TOKEN: c16899297a4b62c6a23fcb5533b32bbec17a6f89
  SONAR_ORG: samfert-codeium
  SONAR_PROJECT_KEY: samfert-codeium_BankingMicroservices
  DEVIN_API_KEY: apk_user_Z29vZ2xlLW9hdXRoMnwxMTEzNTM1ODQ4MjE5NzA5NzY2NDFfb3JnLTMwOWM2NTQ1N2FhMjQyMGNhZjc4NzQ2ZjI5ZTY3YjkxOjAxYTFiMDJiNGVmNDQyM2FiZmYwMTk2ZjMwYTcwOTRj

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: SonarQube Scan
        env:
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
        run: |
          # Using sonar-scanner CLI for flexibility
          curl -sSLo sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip -q sonar-scanner.zip
          ./sonar-scanner-5.0.1.3006-linux/bin/sonar-scanner \
            -Dsonar.projectKey=${{ env.SONAR_PROJECT_KEY }} \
            -Dsonar.organization=${{ env.SONAR_ORG }} \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.token=${{ env.SONAR_TOKEN }}

      - name: Quality Gate Check
        id: quality-gate
        continue-on-error: true
        uses: SonarSource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}

      - name: Check if Devin Remediation Commit
        id: check-devin
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            git fetch origin ${{ github.head_ref }}
            COMMIT_AUTHOR=$(git log -1 --format='%an' origin/${{ github.head_ref }})
            COMMIT_MSG=$(git log -1 --format='%s' origin/${{ github.head_ref }})
            echo "Checking PR commit - Author: $COMMIT_AUTHOR"
            echo "Commit message: $COMMIT_MSG"
          else
            COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            echo "Checking push commit - Author: $COMMIT_AUTHOR"
          fi

          # Check for Devin AI commits or [devin-remediation] tag
          if [[ "$COMMIT_AUTHOR" == "Devin AI" ]] || [[ "$COMMIT_MSG" == *"[devin-remediation]"* ]]; then
            echo "is_devin_commit=true" >> $GITHUB_OUTPUT
            echo "ü§ñ Detected Devin remediation commit - skipping new session trigger"
          else
            echo "is_devin_commit=false" >> $GITHUB_OUTPUT
            echo "üë§ Human commit detected"
          fi

      - name: Extract Quality Gate Failure Details
        id: extract-issues
        if: steps.quality-gate.outcome == 'failure'
        run: |
          echo "üìä Extracting quality gate failure details from SonarQube..."

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            PR_PARAM="&pullRequest=${{ github.event.pull_request.number }}"
          else
            PR_PARAM=""
          fi

          # Extract all issue types
          ALL_ISSUES=$(curl -s -u "${{ env.SONAR_TOKEN }}:" \
            "https://sonarcloud.io/api/issues/search?componentKeys=${{ env.SONAR_PROJECT_KEY }}${PR_PARAM}&resolved=false&ps=100")

          # Get quality gate status details
          QG_STATUS=$(curl -s -u "${{ env.SONAR_TOKEN }}:" \
            "https://sonarcloud.io/api/qualitygates/project_status?projectKey=${{ env.SONAR_PROJECT_KEY }}${PR_PARAM}")

          # Extract metrics
          VULNERABILITIES=$(echo "$ALL_ISSUES" | jq '[.issues[] | select(.type=="VULNERABILITY")] | length')
          BUGS=$(echo "$ALL_ISSUES" | jq '[.issues[] | select(.type=="BUG")] | length')
          CODE_SMELLS=$(echo "$ALL_ISSUES" | jq '[.issues[] | select(.type=="CODE_SMELL")] | length')
          SECURITY_HOTSPOTS=$(echo "$ALL_ISSUES" | jq '[.issues[] | select(.type=="SECURITY_HOTSPOT")] | length')
          TOTAL_ISSUES=$(echo "$ALL_ISSUES" | jq '.total')

          # Extract failed conditions
          FAILED_CONDITIONS=$(echo "$QG_STATUS" | jq -c '[.projectStatus.conditions[] | select(.status=="ERROR") | {metric: .metricKey, actual: .actualValue, threshold: .errorThreshold}]')

          # Create issue summary
          ISSUE_SUMMARY=$(echo "$ALL_ISSUES" | jq -c --arg vuln "$VULNERABILITIES" --arg bugs "$BUGS" --arg smells "$CODE_SMELLS" --arg hotspots "$SECURITY_HOTSPOTS" '{
            total: .total,
            vulnerabilities: ($vuln | tonumber),
            bugs: ($bugs | tonumber),
            code_smells: ($smells | tonumber),
            security_hotspots: ($hotspots | tonumber),
            issues: [.issues[] | {
              key: .key,
              type: .type,
              severity: .severity,
              message: .message,
              component: .component,
              line: .line,
              rule: .rule
            }]
          }')

          echo "total_issues=$TOTAL_ISSUES" >> $GITHUB_OUTPUT
          echo "vulnerabilities=$VULNERABILITIES" >> $GITHUB_OUTPUT
          echo "bugs=$BUGS" >> $GITHUB_OUTPUT
          echo "code_smells=$CODE_SMELLS" >> $GITHUB_OUTPUT
          echo "security_hotspots=$SECURITY_HOTSPOTS" >> $GITHUB_OUTPUT

          # Create formatted issue list for Devin prompt
          FORMATTED_ISSUES=$(echo "$ALL_ISSUES" | jq -r '.issues[] | "- [\(.severity)] \(.message) (\(.component | split(":") | .[-1]):\(.line))"')

          echo "formatted_issues<<EOF" >> $GITHUB_OUTPUT
          echo "$FORMATTED_ISSUES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "‚ö†Ô∏è  Quality Gate Failures:"
          echo "   - Total Issues: $TOTAL_ISSUES"
          echo "   - Vulnerabilities: $VULNERABILITIES"
          echo "   - Bugs: $BUGS"
          echo "   - Code Smells: $CODE_SMELLS"
          echo "   - Security Hotspots: $SECURITY_HOTSPOTS"

      - name: Trigger Devin Remediation (Human PR Only)
        id: trigger-devin
        if: |
          steps.quality-gate.outcome == 'failure' &&
          steps.check-devin.outputs.is_devin_commit == 'false' &&
          github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ü§ñ Triggering Devin AI Quality Gate Remediation..."

          TOTAL_ISSUES="${{ steps.extract-issues.outputs.total_issues }}"
          VULNERABILITIES="${{ steps.extract-issues.outputs.vulnerabilities }}"
          BUGS="${{ steps.extract-issues.outputs.bugs }}"
          CODE_SMELLS="${{ steps.extract-issues.outputs.code_smells }}"
          SECURITY_HOTSPOTS="${{ steps.extract-issues.outputs.security_hotspots }}"
          FORMATTED_ISSUES='${{ steps.extract-issues.outputs.formatted_issues }}'

          # User prompt - simple and direct with link to SonarCloud
          SONAR_URL="https://sonarcloud.io/project/issues?id=${{ env.SONAR_PROJECT_KEY }}&pullRequest=${{ github.event.pull_request.number }}"

          USER_PROMPT="Fix the SonarQube issues on branch ${{ github.head_ref }} and push your fix.

          SonarCloud Report: ${SONAR_URL}"

          # Create Devin session via API
          # Use PR number + run number for idempotency key to get fresh session per workflow run
          DEVIN_SESSION=$(curl -s -X POST "https://api.devin.ai/v1/sessions" \
            -H "Authorization: Bearer ${{ env.DEVIN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg name "SonarQube Fix - PR #${{ github.event.pull_request.number }}" \
              --arg repo "${{ github.server_url }}/${{ github.repository }}" \
              --arg branch "${{ github.head_ref }}" \
              --arg user_prompt "$USER_PROMPT" \
              --arg idempotency_key "pr-${{ github.event.pull_request.number }}-run-${{ github.run_number }}" \
              '{
                name: $name,
                repo_url: $repo,
                branch: $branch,
                prompt: $user_prompt,
                idempotency_key: $idempotency_key
              }'")")

          SESSION_ID=$(echo "$DEVIN_SESSION" | jq -r '.session_id')
          SESSION_URL=$(echo "$DEVIN_SESSION" | jq -r '.url')

          if [ "$SESSION_ID" == "null" ] || [ -z "$SESSION_ID" ]; then
            echo "‚ùå Failed to create Devin session"
            echo "$DEVIN_SESSION"
          else
            echo "‚úÖ Devin session created successfully"
            echo "   Session ID: $SESSION_ID"
            echo "   Session URL: $SESSION_URL"

            # Post comment to PR
            cat << EOF > devin-comment.md
          ## ü§ñ Devin AI Quality Gate Remediation Triggered

          A SonarQube Quality Gate Remediation Specialist (Devin AI) has been assigned to fix all quality gate failures.

          ### üìä Quality Gate Analysis
          - **Total Issues:** ${TOTAL_ISSUES}
          - **Vulnerabilities:** ${VULNERABILITIES} üî¥
          - **Bugs:** ${BUGS} üêõ
          - **Code Smells:** ${CODE_SMELLS} üí®
          - **Security Hotspots:** ${SECURITY_HOTSPOTS} üî•

          ### üîó Links
          - [üëÄ Monitor Devin Session]($SESSION_URL)
          - [üìä SonarQube Dashboard](https://sonarcloud.io/dashboard?id=${{ env.SONAR_PROJECT_KEY }})
          - [üîß GitHub Actions Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---
          **Note:** Devin will push a fix to this branch. The workflow will automatically re-run to validate.
          EOF

            gh pr comment ${{ github.event.pull_request.number }} --body-file devin-comment.md
          fi

      - name: Fail if Quality Gate Failed
        if: steps.quality-gate.outcome == 'failure'
        run: |
          if [[ "${{ steps.check-devin.outputs.is_devin_commit }}" == "true" ]]; then
            echo "‚ùå Quality gate still failing after Devin remediation"
            echo "üîç Human review required"
            echo ""
            echo "Possible reasons:"
            echo "  - Complex issues requiring architectural changes"
            echo "  - False positives needing manual review"
            echo "  - New issues introduced during remediation"
          else
            echo "‚ùå Quality gate failed"
            echo "ü§ñ Devin AI has been triggered to remediate issues"
            echo "‚è≥ Waiting for Devin to commit fixes..."
          fi
          exit 1
